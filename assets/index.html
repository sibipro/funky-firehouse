<html>

<head>
  <title>Funky Firehouse</title>
  <style>
    svg {
      width: 100vw;
      height: 100vh;
      background-color: #ccc;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "d3": "https://esm.sh/d3@7.8.5",
        "d3-force": "https://esm.sh/d3-force@3.0.0"
      }
    }
    </script>
  <style>
  </style>
</head>

<body>
  <svg id="graph">
    <g id="nodes"></g>
    <g id="links"></g>
  </svg>
</body>
<script id="d3-graph-of-events" type="module">
  import { forceSimulation, forceLink, forceCenter, forceManyBody } from 'd3-force'
  const svg = document.getElementById('graph')
  // get svg element's width and height
  const width = svg.clientWidth
  const height = svg.clientHeight
  const nodes = []
  const links = []
  console.log({ width, height })
  const simulation = forceSimulation()
    .force('link', forceLink().id(d => d.id))
    .force('charge', forceManyBody().strength(-30))
    .force('center', forceCenter(width / 2, height / 2))
    .on("tick", ticked)

  // Function to handle simulation ticks
  function ticked() {
    // Move existing SVG elements to new positions
    for (const n of nodes) {
      createOrUpdateNode(n.id)
    }
    for (const l of links) {
      createOrUpdateLink(l.source, l.target)
    }
  }

  const createNode = (id) => {
    const node = document.createElementNS('http://www.w3.org/2000/svg', 'circle')
    node.id = id
    document.getElementById('nodes').appendChild(node)
    node.setAttribute('r', 5)
    return node
  }
  const createOrUpdateNode = (nodeData) => {
    const node = document.getElementById(nodeData.id) ?? createNode(nodeData.id)
    node.setAttribute('cx', nodeData.x)
    node.setAttribute('cy', nodeData.y)


    node.setAttribute('r', 5)
    node.setAttribute('fill', '#69b3a2')
    return node
  }

  /**
 * @param {SVGCircleElement} source
 * @param {SVGCircleElement} target
 */
  const createLink = (source, target) => {
    const link = document.createElementNS('http://www.w3.org/2000/svg', 'line')
    link.id = `${source.id}-${target.id}`
    document.getElementById('links').appendChild(link)
    link.setAttribute('stroke', '#999')
    link.setAttribute('stroke-width', '1')
    return link
  }

  /**
   * @param {SVGCircleElement} source
   * @param {SVGCircleElement} target
   */
  const createOrUpdateLink = (source, target) => {
    const link = document.getElementById(`${source.id}-${target.id}`) ?? createLink(source, target)
    link.setAttribute('x1', source.cx)
    link.setAttribute('y1', source.cy)
    link.setAttribute('x2', target.cx)
    link.setAttribute('y2', target.cy)
  }

  // Function to update the graph
  function updateGraph() {
    // Create or update nodes and links
    for (const link of links) {
      const sourceNode = createOrUpdateNode(link.source)
      const targetNode = createOrUpdateNode(link.target)
      createOrUpdateLink(sourceNode, targetNode)
    }

    // Update simulation with current nodes and links
    simulation.nodes(nodes)
    simulation.force('link').links(links)
    simulation.alpha(1).restart()
  }

  const addRandomNode = () => {
    const node = { id: Math.random(), x: Math.random() * width, y: Math.random() * height }
    nodes.push(node)

    // If there are other nodes, create a link to a random one
    if (nodes.length > 1) {
      const targetNode = nodes[Math.floor(Math.random() * (nodes.length - 1))]
      links.push({ source: node.id, target: targetNode.id })
    }
    console.log({ nodes, links })

    updateGraph()
  }
  setInterval(addRandomNode, 500)

  const websocket = new WebSocket('/websocket')
  websocket.addEventListener('message', (event) => {
    console.log(event)

    const node = { id: Math.random(), x: Math.random() * width, y: Math.random() * height }
    nodes.push(node)

    // If there are other nodes, create a link to a random one
    if (nodes.length > 1) {
      const targetNode = nodes[Math.floor(Math.random() * (nodes.length - 1))]
      links.push({ source: node.id, target: targetNode.id })
    }

    updateGraph()
  })
</script>

</html>
